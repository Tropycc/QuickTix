@model QuickTix.Models.Listing

@{
    ViewData["Title"] = "Listing Details";
    var purchases = ViewBag.Purchases as List<QuickTix.Models.Purchase>;
}

<h1>@Model.Title</h1>

<hr />

<div class="row">
    <div class="col-md-8">
        <dl class="row">
            <dt class="col-sm-3">Description</dt>
            <dd class="col-sm-9">@Model.Description</dd>

            <dt class="col-sm-3">Location</dt>
            <dd class="col-sm-9">@Model.Location</dd>

            <dt class="col-sm-3">Listing Date</dt>
            <dd class="col-sm-9">@Model.ListingDate.ToShortDateString()</dd>

            <dt class="col-sm-3">Ticket Price</dt>
            <dd class="col-sm-9">@Model.TicketPrice.ToString("C")</dd>

            <dt class="col-sm-3">Category</dt>
            <dd class="col-sm-9">@Model.Categories?.Name</dd>

            <dt class="col-sm-3">Owner</dt>
            <dd class="col-sm-9">@Model.Owners?.Name</dd>

            <dt class="col-sm-3">Photo</dt>
            <dd class="col-sm-9">
                @if (!string.IsNullOrEmpty(Model.PhotoFileName))
                {
                    <img src="https://nscc0511519inet.blob.core.windows.net/uploads/@Model.PhotoFileName"
                         alt="Photo"
                         width="150" height="150"
                         style="border-radius:6px;object-fit:cover;" />
                }
                else
                {
                    <em>No photo</em>
                }
            </dd>
        </dl>
    </div>
</div>

<hr />

<div>
    <a asp-controller="Listings" asp-action="Edit" asp-route-id="@Model.ListingId" class="btn btn-primary">Edit Listing</a>
    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Back</a>
</div>

<hr />

<h3>Purchases</h3>

@if (purchases == null || purchases.Count == 0)
{
    <p><em>No purchases yet.</em></p>
}
else
{
    var totalRevenue = purchases.Sum(p => p.TotalPrice);
    var totalQuantity = purchases.Sum(p => p.Quantity);

    <p><strong>Total Sales:</strong> @totalQuantity</p>
    <p><strong>Total Revenue:</strong> @totalRevenue.ToString("C")</p>

    <table class="table table-bordered table-striped mt-3">
        <thead class="table-dark">
            <tr>
                <th>Buyer</th>
                <th>Date</th>
                <th>Qty</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in purchases)
            {
                <tr>
                    <td>@p.BuyerName</td>
                    <td>@p.PurchaseDate.ToShortDateString()</td>
                    <td>@p.Quantity</td>
                    <td>@p.TotalPrice.ToString("C")</td>
                </tr>
            }
        </tbody>
    </table>
}
